name: "CI/CD (aiwebchat: Vue3 + Proxy)"

on:
  push:
    branches: [ "main" ]

env:
  WEB_IMAGE:   ${{ format('{0}/aiwebchat-web',   secrets.DOCKERHUB_USERNAME) }}
  PROXY_IMAGE: ${{ format('{0}/aiwebchat-proxy', secrets.DOCKERHUB_USERNAME) }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 构建 & 推送 前端镜像 ---
      - name: Build & Push aiwebchat-web
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.WEB_IMAGE }}:latest
            ${{ env.WEB_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- 构建 & 推送 代理镜像 ---
      - name: Build & Push aiwebchat-proxy
        uses: docker/build-push-action@v6
        with:
          context: ./proxy
          push: true
          tags: |
            ${{ env.PROXY_IMAGE }}:latest
            ${{ env.PROXY_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- 准备部署包（compose + .env） ---
      - name: Prepare deploy bundle
        run: |
          mkdir -p deploy
          cp docker-compose.prod.yml deploy/docker-compose.yml
          cat > deploy/.env <<EOF
          DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
          WEB_IMAGE=${{ env.WEB_IMAGE }}
          PROXY_IMAGE=${{ env.PROXY_IMAGE }}
          EOF

      # --- 预写 known_hosts，避免首次连接交互（带 IPv4/IPv6 回退 + 重试） ---
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -4 -p ${{ secrets.SSH_PORT }} -T 15 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null \
          || ssh-keyscan -6 -p ${{ secrets.SSH_PORT }} -T 15 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null \
          || (sleep 3 && ssh-keyscan -4 -p ${{ secrets.SSH_PORT }} -T 15 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts)

      # --- 上传到服务器 /opt/aiwebchat ---
      - name: Upload deploy bundle to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy/*"
          target: "/opt/aiwebchat"

      # --- 部署：在服务器写 api.env，compose 更新 ---
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd /opt/aiwebchat
            cat > api.env <<EOF
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            EOF
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
