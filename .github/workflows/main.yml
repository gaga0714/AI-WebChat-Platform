name: ğŸš€ aiwebchat

# å®šä¹‰è§¦å‘å·¥ä½œæµçš„äº‹ä»¶ï¼Œå½“ main åˆ†æ”¯æœ‰æ–°çš„ push æ—¶è§¦å‘
on:
  push:
    branches:
      - main

# é›†ä¸­ç®¡ç†ç¯å¢ƒå˜é‡ï¼Œä¾¿äºç»´æŠ¤
env:
  # æœåŠ¡å™¨ä¸Šçš„é¡¹ç›®éƒ¨ç½²è·¯å¾„ï¼Œè¯·æ ¹æ®ä½ çš„é¡¹ç›®ä¿®æ”¹
  DEPLOY_PATH: /home/html/aiwebchat/
  # é¡¹ç›®æ„å»ºå‘½ä»¤ï¼Œå¦‚æœæ˜¯ Vite é¡¹ç›®é€šå¸¸æ˜¯ 'build'
  BUILD_SCRIPT: build
  # æ„å»ºäº§ç‰©ç›®å½•ï¼Œé€šå¸¸æ˜¯ 'dist'
  BUILD_DIR: dist
  # GitHub Actions Secrets
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Build Project
        run: npm run ${{ env.BUILD_SCRIPT }}

      - name: ğŸ§¹ Clean Server Directory
        # ä½¿ç”¨ SSH å‘½ä»¤æ¸…ç©ºæœåŠ¡å™¨ä¸Šçš„æ—§æ–‡ä»¶ï¼Œç¡®ä¿éƒ¨ç½²çš„æ˜¯æœ€æ–°å†…å®¹
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "Cleaning up old files in ${{ env.DEPLOY_PATH }}"
            rm -rf ${{ env.DEPLOY_PATH }}/*

      - name: ğŸ“¤ Upload Build Files to Server
        # ä½¿ç”¨ SCP å°†æ„å»ºåçš„æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: "${{ env.BUILD_DIR }}/**"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 1

      - name: ğŸ”„ Restart Nginx
        # é‡å¯ Nginx æœåŠ¡ï¼Œä»¥ç¡®ä¿æ–°æ–‡ä»¶è¢«æ­£ç¡®åŠ è½½
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "Restarting Nginx service..."
            sudo systemctl restart nginx
