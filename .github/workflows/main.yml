name: ğŸ³ aiwebchat Docker CI/CD

on:
  push:
    branches:
      - main

env:
  # ç»Ÿä¸€ç®¡ç†å®¹å™¨é•œåƒåç§°å’Œæ ‡ç­¾
  IMAGE_NAME: aiwebchat-app
  IMAGE_TAG: ${{ github.sha }}
  
  # Docker Hub æˆ–å…¶ä»–å®¹å™¨ä»“åº“ä¿¡æ¯
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  
  # éƒ¨ç½²æœåŠ¡å™¨ä¿¡æ¯ï¼Œç”¨äºSSHè¿æ¥
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  SSH_PORT: 22

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      # âœ… æ–°å¢æ­¥éª¤ï¼šè®¾ç½® buildx ä»¥æ”¯æŒå¤šæ¶æ„æ„å»º
      - name: ğŸ›  Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # âœ… å…³é”®ä¿®æ”¹ï¼šç™»å½•åˆ° Docker é•œåƒä»“åº“
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # âœ… å…³é”®ä¿®æ”¹ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ“¦ Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          build-args: |
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}

      # âŒ ç§»é™¤æ—§çš„ SSH/SCP æ­¥éª¤ï¼Œä»…ä¿ç•™éƒ¨ç½²
      - name: ğŸš€ Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "Pulling latest Docker image..."
            sudo docker pull ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

            # åœæ­¢å¹¶ç§»é™¤æ—§çš„å®¹å™¨
            echo "Stopping and removing old container..."
            sudo docker stop ${{ env.IMAGE_NAME }} || true
            sudo docker rm ${{ env.IMAGE_NAME }} || true

            # å¯åŠ¨æ–°çš„å®¹å™¨
            echo "Starting new container..."
            sudo docker run -d --name ${{ env.IMAGE_NAME }} -p 80:80 ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            
            echo "Deployment finished successfully!"