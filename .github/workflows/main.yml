name: ðŸš€ aiwebchat

on:
  push:
    branches:
      - main

env:
  DEPLOY_PATH: /home/html/aiwebchat/
  BUILD_SCRIPT: build
  BUILD_DIR: dist
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  SSH_PORT: ${{secrets.SSH_PORT }}
  # æ–°å¢žä¸€ä¸ªç”¨äºŽå­˜å‚¨ API å¯†é’¥çš„ Secret å˜é‡
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      # âœ… æ–°å¢žçš„æ­¥éª¤ï¼šåŠ¨æ€åˆ›å»º key.js æ–‡ä»¶
      - name: ðŸ” Create API Key File
        run: |
          mkdir -p src/config
          # ç¡®ä¿è¿™é‡Œçš„è·¯å¾„å’Œæ–‡ä»¶åä¸Žä½  deepseek.js ä¸­å¯¼å…¥çš„è·¯å¾„ä¸€è‡´
          echo "export const apiKey = '${{ env.DEEPSEEK_API_KEY }}';" > src/config/key.js
      
      - name: ðŸ”§ Build Project
        run: npm run ${{ env.BUILD_SCRIPT }}

      - name: ðŸ§¹ Clean Server Directory
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            echo "Cleaning up old files in ${{ env.DEPLOY_PATH }}"
            rm -rf ${{ env.DEPLOY_PATH }}*

      - name: ðŸ“¤ Upload Build Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "${{ env.BUILD_DIR }}/**"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 1

      - name: ðŸ”„ Restart Nginx
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            echo "Restarting Nginx service..."
            sudo systemctl restart nginx