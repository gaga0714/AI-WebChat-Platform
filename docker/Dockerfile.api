FROM node:20-alpine
WORKDIR /app

RUN corepack enable && corepack prepare pnpm@8.15.4 --activate

# 先只拷贝依赖清单
COPY package.json pnpm-lock.yaml* package-lock.json* yarn.lock*  ./

# 只装生产依赖
RUN pnpm install --prod --frozen-lockfile

# 批准构建脚本（v10 需要；v8 忽略）
RUN pnpm approve-builds --all || true

# 拷贝后端源码
COPY server ./server

ENV NODE_ENV=production
ENV PORT=8787
EXPOSE 8787

CMD ["node", "server/server.js"]
