FROM node:20-alpine
WORKDIR /app

# 与本地一致使用 pnpm v10（示例 10.7.1）
RUN corepack enable && corepack prepare pnpm@10.7.1 --activate

# 仅拷贝依赖清单（不拷贝 pnpm-workspace.yaml）
COPY package.json pnpm-lock.yaml* package-lock.json* yarn.lock* ./

# 仅安装生产依赖（严格使用锁文件）
RUN pnpm install --prod --frozen-lockfile

# 批准需要执行安装脚本的依赖（v10）
RUN pnpm approve-builds --all

# 拷贝后端源码
COPY server ./server

ENV NODE_ENV=production
ENV PORT=8787
EXPOSE 8787

CMD ["node", "server/server.js"]
