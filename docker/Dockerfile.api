FROM node:20-alpine
WORKDIR /app

RUN corepack enable && corepack prepare pnpm@10.7.1 --activate

# 先拷贝依赖清单 + .npmrc（白名单需在 install 前到位）
COPY package.json pnpm-lock.yaml* package-lock.json* yarn.lock* .npmrc* ./

# 仅装生产依赖（严格使用锁文件）
RUN pnpm install --prod --frozen-lockfile

# 拷贝后端源码
COPY server ./server

ENV NODE_ENV=production
ENV PORT=8787
EXPOSE 8787

CMD ["node", "server/server.js"]
